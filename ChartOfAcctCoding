USE [BLISSIMPORT]
GO

/****** Object:  StoredProcedure [dbo].[COA_CODING]    Script Date: 3/08/2015 4:33:53 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[COA_CODING]
@CLIENTID NVARCHAR(15),
@ID NVARCHAR(20),
@COA NVARCHAR(50),
@TAX NVARCHAR(10),
@DESC NVARCHAR(200)

AS

SELECT 'BEFORE POSTING', * FROM CATEGORIZE1 WHERE GL_ID LIKE @ID AND TRX_TYPE <> 'BANK'

UPDATE CATEGORIZE1
SET COA = @COA, TAX = @TAX,
DESCRIPTION = CASE WHEN ISNULL(@DESC,'')='' THEN (SELECT DESCRIPTION FROM CATEGORIZE1 WHERE GL_ID = @ID AND TRX_TYPE <> 'BANK') ELSE 
(SELECT DESCRIPTION FROM CATEGORIZE1 WHERE GL_ID = @ID AND TRX_TYPE <> 'BANK') + '-' + @DESC END
WHERE GL_ID = @ID AND
TRX_TYPE <> 'BANK'

SELECT 'AFTER POSTING', * FROM CATEGORIZE1 WHERE GL_ID = @ID AND TRX_TYPE <> 'BANK'

SELECT c.CLIENT_ID, id.DESCRIPTION, DATE, 
c.TRX_TYPE, c.GL_ID, c.DESCRIPTION, c.NET, c.COA, c.TAX

FROM CATEGORIZE1 c INNER JOIN BLISSIMPORT.DBO.CLIENT_ID id
ON c.CLIENT_ID = id.[CLIENT ID]

WHERE TRX_TYPE <> 'BANK' AND COA = '' AND CLIENT_ID IN ( @CLIENTID )

ORDER BY DATE





GO


